<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Xv6 homeworks | ExiTalk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Reports of MIT 6.828 xv6 homeworks">
<meta property="og:type" content="article">
<meta property="og:title" content="Xv6 homeworks">
<meta property="og:url" content="http://www.superpung.xyz/Xv6-homeworks/">
<meta property="og:site_name" content="ExiTalk">
<meta property="og:description" content="Reports of MIT 6.828 xv6 homeworks">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-12-29T11:01:25.000Z">
<meta property="article:modified_time" content="2020-12-31T03:56:28.000Z">
<meta property="article:author" content="SUPER">
<meta property="article:tag" content="Experiments">
<meta property="article:tag" content="Operating Systems">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="ExiTalk" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ExiTalk</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Follow your heart</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.superpung.xyz"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Xv6-homeworks" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/Xv6-homeworks/" class="article-date">
  <time class="dt-published" datetime="2020-12-29T11:01:25.000Z" itemprop="datePublished">2020-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Xv6 homeworks
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Reports of MIT 6.828 xv6 homeworks</p>
<a id="more"></a>

<h1 id="xv6-system-calls"><a href="#xv6-system-calls" class="headerlink" title="xv6 system calls"></a>xv6 system calls</h1><h2 id="Part-One-System-call-tracing"><a href="#Part-One-System-call-tracing" class="headerlink" title="Part One: System call tracing"></a>Part One: System call tracing</h2><p>修改xv6内核，在实现系统调用时打印系统调用的名称和返回值。</p>
<p>只需在<code>syscall.c</code>中系统调用时增加一行输出即可。</p>
<p>为了输出系统调用名称，增加对应的数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *syscalls_name[] = &#123;</span><br><span class="line">[SYS_fork]    <span class="string">&quot;fork&quot;</span>,</span><br><span class="line">[SYS_exit]    <span class="string">&quot;exit&quot;</span>,</span><br><span class="line">[SYS_wait]    <span class="string">&quot;wait&quot;</span>,</span><br><span class="line">[SYS_pipe]    <span class="string">&quot;pipe&quot;</span>,</span><br><span class="line">[SYS_read]    <span class="string">&quot;read&quot;</span>,</span><br><span class="line">[SYS_kill]    <span class="string">&quot;kill&quot;</span>,</span><br><span class="line">[SYS_exec]    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">[SYS_fstat]   <span class="string">&quot;fstat&quot;</span>,</span><br><span class="line">[SYS_chdir]   <span class="string">&quot;chdir&quot;</span>,</span><br><span class="line">[SYS_dup]     <span class="string">&quot;dup&quot;</span>,</span><br><span class="line">[SYS_getpid]  <span class="string">&quot;getpid&quot;</span>,</span><br><span class="line">[SYS_sbrk]    <span class="string">&quot;sbrk&quot;</span>,</span><br><span class="line">[SYS_sleep]   <span class="string">&quot;sleep&quot;</span>,</span><br><span class="line">[SYS_uptime]  <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">[SYS_open]    <span class="string">&quot;open&quot;</span>,</span><br><span class="line">[SYS_write]   <span class="string">&quot;write&quot;</span>,</span><br><span class="line">[SYS_mknod]   <span class="string">&quot;mknod&quot;</span>,</span><br><span class="line">[SYS_unlink]  <span class="string">&quot;unlink&quot;</span>,</span><br><span class="line">[SYS_link]    <span class="string">&quot;link&quot;</span>,</span><br><span class="line">[SYS_mkdir]   <span class="string">&quot;mkdir&quot;</span>,</span><br><span class="line">[SYS_close]   <span class="string">&quot;close&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>利用定义的数组，在<code>syscall</code>函数中增加输出（11行）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">syscall(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">curproc</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = curproc-&gt;tf-&gt;eax;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    curproc-&gt;tf-&gt;eax = syscalls[num]();</span><br><span class="line">    cprintf(<span class="string">&quot;%s -&gt; %d\n&quot;</span>, syscalls_name[num], curproc-&gt;tf-&gt;eax);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cprintf(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            curproc-&gt;pid, curproc-&gt;name, num);</span><br><span class="line">    curproc-&gt;tf-&gt;eax = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新运行<code>make qemu</code>，得到输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make qemu</span></span><br><span class="line">qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512 </span><br><span class="line">xv6...</span><br><span class="line">cpu1: starting 1</span><br><span class="line">cpu0: starting 0</span><br><span class="line">sb: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmap start 58</span><br><span class="line">exec -&gt; 0</span><br><span class="line">open -&gt; 0</span><br><span class="line">dup -&gt; 1</span><br><span class="line">dup -&gt; 2</span><br><span class="line">iwrite -&gt; 1</span><br><span class="line">nwrite -&gt; 1</span><br><span class="line">iwrite -&gt; 1</span><br><span class="line">twrite -&gt; 1</span><br><span class="line">:write -&gt; 1</span><br><span class="line"> write -&gt; 1</span><br><span class="line">swrite -&gt; 1</span><br><span class="line">twrite -&gt; 1</span><br><span class="line">awrite -&gt; 1</span><br><span class="line">rwrite -&gt; 1</span><br><span class="line">twrite -&gt; 1</span><br><span class="line">iwrite -&gt; 1</span><br><span class="line">nwrite -&gt; 1</span><br><span class="line">gwrite -&gt; 1</span><br><span class="line"> write -&gt; 1</span><br><span class="line">swrite -&gt; 1</span><br><span class="line">hwrite -&gt; 1</span><br><span class="line"></span><br><span class="line">write -&gt; 1</span><br><span class="line">fork -&gt; 2</span><br><span class="line">exec -&gt; 0</span><br><span class="line">open -&gt; 3</span><br><span class="line">close -&gt; 0</span><br><span class="line"><span class="meta">$</span><span class="bash">write -&gt; 1</span></span><br><span class="line"> write -&gt; 1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Part-Two-Date-system-call"><a href="#Part-Two-Date-system-call" class="headerlink" title="Part Two: Date system call"></a>Part Two: Date system call</h2><p>增加一个新的系统调用，输出当前UTC（Coordinated Universal Time，协调世界时）时间。</p>
<p>根据提示，通过分析已经实现的系统调用（如<code>uptime</code>）来创建新的系统调用<code>date</code>。</p>
<p><code>grep -n uptime *.[chS]</code>查看所有含<code>uptime</code>的<code>.c</code>、<code>.h</code>和<code>.S</code>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syscall.c:105:extern int sys_uptime(void);</span><br><span class="line">syscall.c:124:[SYS_uptime]  sys_uptime,</span><br><span class="line">syscall.c:149:[SYS_uptime]  &quot;uptime&quot;,</span><br><span class="line">syscall.h:15:#define SYS_uptime 14</span><br><span class="line">sysproc.c:83:sys_uptime(void)</span><br><span class="line">user.h:25:int uptime(void);</span><br><span class="line">usys.S:31:SYSCALL(uptime)</span><br></pre></td></tr></table></figure>
<p>依次在上述文件的对应位置添加系统调用<code>date</code>。</p>
<p><code>syscall.h</code>（添加系统调用编号）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_date 22</span></span><br></pre></td></tr></table></figure>
<p><code>syscall.c</code>（添加系统调用函数的外部声明）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[SYS_date]  <span class="string">&quot;date&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">···</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_date</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">···</span><br><span class="line">[SYS_date] sys_date</span><br></pre></td></tr></table></figure>
<p><code>user.h</code>（添加用户态函数的定义）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">date</span><span class="params">(struct rtcdate*)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>usys.S</code>（添加用户态函数的实现）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL(date)</span><br></pre></td></tr></table></figure>
<p><code>sysproc.c</code>（添加系统调用函数的实现）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">sys_date(struct rtcdate *r)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argptr(<span class="number">0</span>, (<span class="keyword">void</span> *)&amp;r, <span class="keyword">sizeof</span>(*r)) &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  	cmostime(r);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>根据提示，新建文件 <code>date.c</code> ，添加使用此系统调用函数的方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;date.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtcdate</span> <span class="title">r</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (date(&amp;r))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;date failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// your code to print the time in any format you like...</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="number">1</span>, <span class="string">&quot;%d/%d/%d %d:%d:%d\n&quot;</span>, r.month, r.day, r.year, r.hour, r.minute, r.second);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>MakeFile</code>中添加<code>UPROGS</code>对应的命令：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_date\</span><br></pre></td></tr></table></figure>
<p>注释掉<code>Part One</code>的更改，重新运行<code>make qemu</code>，得到输出如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ date</span><br><span class="line"><span class="number">12</span>/<span class="number">28</span> <span class="number">2020</span> <span class="number">7</span>:<span class="number">15</span>:<span class="number">27</span> </span><br></pre></td></tr></table></figure>
<h1 id="xv6-lazy-page-allocation"><a href="#xv6-lazy-page-allocation" class="headerlink" title="xv6 lazy page allocation"></a>xv6 lazy page allocation</h1><h2 id="Part-One-Eliminate-allocation-from-sbrk"><a href="#Part-One-Eliminate-allocation-from-sbrk" class="headerlink" title="Part One: Eliminate allocation from sbrk()"></a>Part One: Eliminate allocation from sbrk()</h2><p>实现页面延迟分配的第一步，消除系统调用<code>sbrk</code>中的分配。</p>
<p>修改系统调用<code>sbrk</code>的实际实现<code>sys_sbrk</code>，使它只将进程的内存空间大小增加<code>n</code>，而不进行实际的分配。</p>
<p>在<code>sysproc.c</code>的<code>sys_sbrk</code>函数中，根据提示，增加进程大小<code>n</code>，并返回旧的大小。不分配内存，注释掉<code>growproc</code>函数的调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">sys_sbrk(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> addr;</span><br><span class="line">  <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  addr = myproc()-&gt;sz;</span><br><span class="line">  myproc()-&gt;sz += n;</span><br><span class="line">  <span class="comment">// if(growproc(n) &lt; 0)</span></span><br><span class="line">  <span class="comment">//   return -1;</span></span><br><span class="line">  <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新运行<code>make qemu</code>并键入<code>echo hi</code>，得到输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> hi</span></span><br><span class="line">pid 3 sh: trap 14 err 6 on cpu 0 eip 0x12e9 addr 0x4004--kill proc</span><br></pre></td></tr></table></figure>
<h2 id="Part-Two-Lazy-allocation"><a href="#Part-Two-Lazy-allocation" class="headerlink" title="Part Two: Lazy allocation"></a>Part Two: Lazy allocation</h2><p>实现页面延迟分配的第二步，响应第一步造成的错误，使进程继续执行。</p>
<p>根据提示，修改<code>trap.c</code>中的代码，以通过在故障地址处映射新分配的物理内存页来响应用户空间中的页面错误，然后返回到用户空间以使进程继续执行。</p>
<p>根据提示，在<code>trap.c</code>的<code>trap</code>函数<code>switch</code>语句中增加<code>case</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_PGFLT: &#123;</span><br><span class="line">  <span class="keyword">char</span> *mem;</span><br><span class="line">  mem = kalloc();</span><br><span class="line">  <span class="keyword">if</span>(mem != <span class="number">0</span>)&#123;</span><br><span class="line">	uint va = PGROUNDDOWN(rcr2());</span><br><span class="line">	<span class="built_in">memset</span>(mem, <span class="number">0</span>, PGSIZE);</span><br><span class="line">	<span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mappages</span><span class="params">(<span class="keyword">pde_t</span> *pgdir, <span class="keyword">void</span> *va, uint size, uint pa, <span class="keyword">int</span> perm)</span></span>;</span><br><span class="line">	<span class="keyword">if</span>(mappages(myproc()-&gt;pgdir,(<span class="keyword">void</span> *)va, PGSIZE, V2P(mem), PTE_W|PTE_U) &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若在<code>case T_PGFLT:</code>后未加<code>&#123;&#125;</code>，运行<code>make qemu</code>则会报以下错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make qemu</span></span><br><span class="line">gcc -fno-pic -static -fno-builtin -fno-strict-aliasing -O2 -Wall -MD -ggdb -m32 -Werror -fno-omit-frame-pointer -fno-stack-protector   -c -o trap.o trap.c</span><br><span class="line">trap.c: In function ‘trap’:</span><br><span class="line">trap.c:86: error: a label can only be part of a statement and a declaration is not a statement</span><br><span class="line">&lt;内置&gt;: recipe for target &#x27;trap.o&#x27; failed</span><br><span class="line">make: *** [trap.o] Error 1</span><br></pre></td></tr></table></figure>
<p>根据提示，为了在<code>trap.c</code>中调用<code>mappages</code>函数，需要删除<code>vm.c</code>中<code>mappages</code>函数声明中的<code>static</code>。</p>
<p>重新运行<code>make qemu</code>并键入<code>echo hi</code>，得到输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> hi</span></span><br><span class="line">hi</span><br></pre></td></tr></table></figure>
<h1 id="xv6-CPU-alarm"><a href="#xv6-CPU-alarm" class="headerlink" title="xv6 CPU alarm"></a>xv6 CPU alarm</h1><p>增加系统调用<code>alarm</code>，当进程使用CPU时间时，它会定期向进程发出警报。</p>
<p>仿照实验<code>xv6 system calls</code>中增加系统调用<code>date</code>的方法增加系统调用<code>alarm</code>，按照提示操作。</p>
<p>增加系统调用<code>alarm</code>：</p>
<p><code>syscall.h</code>（添加系统调用编号）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_alarm 23</span></span><br></pre></td></tr></table></figure>
<p><code>syscall.c</code>（添加系统调用函数的外部声明）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[SYS_alarm]  <span class="string">&quot;alarm&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">···</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sys_alarm</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">···</span><br><span class="line">[SYS_alarm] sys_alarm</span><br></pre></td></tr></table></figure>
<p><code>user.h</code>（添加用户态函数的定义）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alarm</span><span class="params">(<span class="keyword">int</span> ticks, <span class="keyword">void</span>(*handler)())</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>usys.S</code>（添加用户态函数的实现）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL(alarm)</span><br></pre></td></tr></table></figure>
<p><code>sysproc.c</code>（添加系统调用函数的实现）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cpu alarm</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">sys_alarm(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> ticks;</span><br><span class="line">  <span class="keyword">void</span> (*handler)();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;ticks) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span>(argptr(<span class="number">1</span>, (<span class="keyword">char</span>**)&amp;handler, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  myproc()-&gt;alarmticks = ticks;</span><br><span class="line">  myproc()-&gt;alarmhandler = handler;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据提示，在 <code>proc.h</code> 的结构体 <code>proc</code> 中添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> alarmticks;</span><br><span class="line"><span class="keyword">int</span> curticks;</span><br><span class="line"><span class="keyword">void</span> (*alarmhandler)();</span><br></pre></td></tr></table></figure>
<p>根据提示，新建文件<code>alarmtest.c</code>，添加使用此系统调用函数的方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">periodic</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="number">1</span>, <span class="string">&quot;alarmtest starting\n&quot;</span>);</span><br><span class="line">  alarm(<span class="number">10</span>, periodic);</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">25</span>*<span class="number">500000</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>((i % <span class="number">250000</span>) == <span class="number">0</span>)</span><br><span class="line">      write(<span class="number">2</span>, <span class="string">&quot;.&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">periodic()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="number">1</span>, <span class="string">&quot;alarm!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>MakeFile</code>中添加<code>UPROGS</code>对应的命令：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_alarmtest\</span><br></pre></td></tr></table></figure>
<p>根据提示，在<code>trap.c</code>中处理时钟中断添加<code>handler</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_IRQ0 + IRQ_TIMER:</span><br><span class="line">  <span class="keyword">if</span>(cpuid() == <span class="number">0</span>)&#123;</span><br><span class="line">    acquire(&amp;tickslock);</span><br><span class="line">    ticks++;</span><br><span class="line">    wakeup(&amp;ticks);</span><br><span class="line">    release(&amp;tickslock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(myproc() != <span class="number">0</span> &amp;&amp; (tf-&gt;cs &amp; <span class="number">3</span>) == <span class="number">3</span>) &#123;</span><br><span class="line">    myproc()-&gt;curticks++;</span><br><span class="line">    <span class="keyword">if</span>(myproc()-&gt;alarmticks == myproc()-&gt;curticks) &#123;</span><br><span class="line">      myproc()-&gt;curticks = <span class="number">0</span>;</span><br><span class="line">      tf-&gt;esp -= <span class="number">4</span>;    </span><br><span class="line">      *((uint *)(tf-&gt;esp)) = tf-&gt;eip;</span><br><span class="line">      tf-&gt;eip =(uint)myproc()-&gt;alarmhandler;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  lapiceoi();</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>重新运行<code>make qemu</code>并键入<code>alarmtest</code>，得到输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> alarmtest</span></span><br><span class="line">alarmtest starting</span><br><span class="line">...........................................alarm!</span><br></pre></td></tr></table></figure>
<p>根据提示：</p>
<blockquote>
<p>If you only see one “alarm!”, try increasing the number of iterations in <code>alarmtest.c</code> by 10x.</p>
</blockquote>
<p>将<code>alarmtest.c</code>中<code>for</code>循环的判断条件改为<code>i &lt; 250*500000</code>，再次运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> alarmtest</span></span><br><span class="line">alarmtest starting</span><br><span class="line">...............................................alarm!</span><br><span class="line">.........................................................................................................alarm!</span><br><span class="line">....................................................................................................................alarm!</span><br><span class="line">............................................................................alarm!</span><br><span class="line">..............................................................................alarm!</span><br><span class="line">...........................................................................alarm!</span><br></pre></td></tr></table></figure>
<h1 id="xv6-locking"><a href="#xv6-locking" class="headerlink" title="xv6 locking"></a>xv6 locking</h1><p>探索中断和锁的相互作用。</p>
<h2 id="Don’t-do-this"><a href="#Don’t-do-this" class="headerlink" title="Don’t do this"></a>Don’t do this</h2><p>执行以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lk</span>;</span></span><br><span class="line">initlock(&amp;lk, <span class="string">&quot;test lock&quot;</span>);</span><br><span class="line">acquire(&amp;lk);</span><br><span class="line">acquire(&amp;lk);</span><br></pre></td></tr></table></figure>
<p>根据提示，在 <code>spinlock.c</code>的<code>acquire</code> 函数中发现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(holding(lk))</span><br><span class="line">  panic(<span class="string">&quot;acquire&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>则执行代码后，连续两次申请同一个<code>spinlock</code>，内核将<code>panic</code>。</p>
<h2 id="Interrupts-in-ide-c"><a href="#Interrupts-in-ide-c" class="headerlink" title="Interrupts in ide.c"></a>Interrupts in ide.c</h2><p>未修改时：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make qemu</span></span><br><span class="line">qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512 </span><br><span class="line">xv6...</span><br><span class="line">cpu1: starting 1</span><br><span class="line">cpu0: starting 0</span><br><span class="line">sb: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmap start 58</span><br><span class="line">init: starting sh</span><br></pre></td></tr></table></figure>
<p>在<code>ide.c</code>的<code>iderw</code>函数中，在调用<code>acquire</code>函数后调用<code>sti</code>函数，在调用<code>release</code>函数前调用<code>cli</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">iderw(struct buf *b)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> **<span class="title">pp</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;iderw: buf not locked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>((b-&gt;flags &amp; (B_VALID|B_DIRTY)) == B_VALID)</span><br><span class="line">    panic(<span class="string">&quot;iderw: nothing to do&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(b-&gt;dev != <span class="number">0</span> &amp;&amp; !havedisk1)</span><br><span class="line">    panic(<span class="string">&quot;iderw: ide disk 1 not present&quot;</span>);</span><br><span class="line"></span><br><span class="line">  acquire(&amp;idelock);  <span class="comment">//DOC:acquire-lock</span></span><br><span class="line">  sti();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Append b to idequeue.</span></span><br><span class="line">  b-&gt;qnext = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(pp=&amp;idequeue; *pp; pp=&amp;(*pp)-&gt;qnext)  <span class="comment">//DOC:insert-queue</span></span><br><span class="line">    ;</span><br><span class="line">  *pp = b;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start disk if necessary.</span></span><br><span class="line">  <span class="keyword">if</span>(idequeue == b)</span><br><span class="line">    idestart(b);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait for request to finish.</span></span><br><span class="line">  <span class="keyword">while</span>((b-&gt;flags &amp; (B_VALID|B_DIRTY)) != B_VALID)&#123;</span><br><span class="line">    sleep(b, &amp;idelock);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cli();</span><br><span class="line">  release(&amp;idelock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新运行<code>make qemu</code>，得到输出如下，发生<code>panic</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make qemu</span></span><br><span class="line">qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512 </span><br><span class="line">xv6...</span><br><span class="line">cpu1: starting 1</span><br><span class="line">cpu0: starting 0</span><br><span class="line">sb: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmap start 58</span><br><span class="line">init: starting sh</span><br><span class="line">lapicid 1: panic: sched locks</span><br><span class="line"> 80103cde 80103eb3 801058cd 801055d1 801001c6 801017af 80106d74 80100afb 801049df 801047ae</span><br></pre></td></tr></table></figure>
<p>发生<code>panic</code>的原因可能是在<code>release</code>释放锁之前发生中断，为了响应中断进行调度，此时又有新的锁申请，所以发生<code>panic</code>。</p>
<h2 id="Interrupts-in-file-c"><a href="#Interrupts-in-file-c" class="headerlink" title="Interrupts in file.c"></a>Interrupts in file.c</h2><p>根据提示，在<code>file.c</code>的<code>filealloc</code>函数中，在调用<code>acquire</code>函数后调用<code>sti</code>函数，在每次调用<code>release</code>函数前调用<code>cli</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate a file structure.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>*</span></span><br><span class="line"><span class="class"><span class="title">filealloc</span>(<span class="title">void</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;ftable.lock);</span><br><span class="line">  sti();</span><br><span class="line">  <span class="keyword">for</span>(f = ftable.file; f &lt; ftable.file + NFILE; f++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(f-&gt;ref == <span class="number">0</span>)&#123;</span><br><span class="line">      f-&gt;ref = <span class="number">1</span>;</span><br><span class="line">      cli();</span><br><span class="line">      release(&amp;ftable.lock);</span><br><span class="line">      <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cli();</span><br><span class="line">  release(&amp;ftable.lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要<code>#include &quot;x86.h&quot;</code>。</p>
<p>重新运行<code>make qemu</code>，得到输出如下，未发生<code>panic</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make qemu</span></span><br><span class="line">qemu-system-i386 -serial mon:stdio -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512 </span><br><span class="line">xv6...</span><br><span class="line">cpu1: starting 1</span><br><span class="line">cpu0: starting 0</span><br><span class="line">sb: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmap start 58</span><br><span class="line">init: starting sh</span><br></pre></td></tr></table></figure>
<p>未发生<code>panic</code>的原因可能是<code>filealloc</code>占用时间短、发生次数较少，只有极小概率与其他读写文件发生冲突。</p>
<h2 id="xv6-lock-implementation"><a href="#xv6-lock-implementation" class="headerlink" title="xv6 lock implementation"></a>xv6 lock implementation</h2><p>相关代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Release the lock.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">release(struct spinlock *lk)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holding(lk))</span><br><span class="line">    panic(<span class="string">&quot;release&quot;</span>);</span><br><span class="line"></span><br><span class="line">  lk-&gt;pcs[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  lk-&gt;cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tell the C compiler and the processor to not move loads or stores</span></span><br><span class="line">  <span class="comment">// past this point, to ensure that all the stores in the critical</span></span><br><span class="line">  <span class="comment">// section are visible to other cores before the lock is released.</span></span><br><span class="line">  <span class="comment">// Both the C compiler and the hardware may re-order loads and</span></span><br><span class="line">  <span class="comment">// stores; __sync_synchronize() tells them both not to.</span></span><br><span class="line">  __sync_synchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Release the lock, equivalent to lk-&gt;locked = 0.</span></span><br><span class="line">  <span class="comment">// This code can&#x27;t use a C assignment, since it might</span></span><br><span class="line">  <span class="comment">// not be atomic. A real OS would use C atomics here.</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;movl $0, %0&quot;</span> : <span class="string">&quot;+m&quot;</span> (lk-&gt;locked) : )</span></span>;</span><br><span class="line"></span><br><span class="line">  popcli();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若<code>release</code>函数先将<code>lk-&gt;locked</code>清零，其他正在<code>acquire()</code>等待的进程将立即执行，将会更改<code>lk-&gt;pcs[0]</code>和<code>lk-&gt;cpu</code>，但此时<code>release</code>函数也将修改<code>lk-&gt;pcs[0]</code>和<code>lk-&gt;cpu</code>值，故发生错误。</p>
<h1 id="bigger-files-for-xv6"><a href="#bigger-files-for-xv6" class="headerlink" title="bigger files for xv6"></a>bigger files for xv6</h1><p>增加xv6文件的最大大小，从<code>140 sectors</code>到<code>16523 sectors</code>。</p>
<p>根据提示，修改<code>Makefile</code>：</p>
<ul>
<li>修改<code>CPUS := 2</code>为<code>CPUS := 1</code></li>
<li>添加<code>QWMUEXTRA = -snapshot</code></li>
<li>在<code>UPROGS</code>中添加<code>_big\</code>：</li>
</ul>
<p>根据提示，修改<code>param.h</code>：</p>
<ul>
<li>修改<code>#define FSSIZE 1000</code>为<code>#define FSSIZE 20000</code></li>
</ul>
<p>根据提示，添加文件<code>big.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line">  <span class="keyword">int</span> fd, i, sectors;</span><br><span class="line"></span><br><span class="line">  fd = open(<span class="string">&quot;big.file&quot;</span>, O_CREATE | O_WRONLY);</span><br><span class="line">  <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;big: cannot open big.file for writing\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sectors = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    *(<span class="keyword">int</span>*)buf = sectors;</span><br><span class="line">    <span class="keyword">int</span> cc = write(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span>(cc &lt;= <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sectors++;</span><br><span class="line">	<span class="keyword">if</span> (sectors % <span class="number">100</span> == <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="number">1</span>, <span class="string">&quot;\nwrote %d sectors\n&quot;</span>, sectors);</span><br><span class="line"></span><br><span class="line">  close(fd);</span><br><span class="line">  fd = open(<span class="string">&quot;big.file&quot;</span>, O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;big: cannot re-open big.file for reading\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sectors; i++)&#123;</span><br><span class="line">    <span class="keyword">int</span> cc = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span>(cc &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;big: read error at sector %d\n&quot;</span>, i);</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(*(<span class="keyword">int</span>*)buf != i)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="number">2</span>, <span class="string">&quot;big: read the wrong data (%d) for sector %d\n&quot;</span>,</span><br><span class="line">             *(<span class="keyword">int</span>*)buf, i);</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="number">1</span>, <span class="string">&quot;done; ok\n&quot;</span>); </span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时重新运行<code>make qemu</code>并键入<code>big</code>，显示<code>wrote 140 sectors</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> big</span> </span><br><span class="line">.</span><br><span class="line">wrote 140 sectors</span><br><span class="line">done; ok</span><br></pre></td></tr></table></figure>
<p>根据提示，修改<code>fs.c</code>中的<code>bmap</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> uint</span><br><span class="line">bmap(struct inode *ip, uint bn)</span><br><span class="line">&#123;</span><br><span class="line">  uint addr, *a;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">bp2</span>;</span></span><br><span class="line">  <span class="keyword">if</span>(bn &lt; NDIRECT)&#123;</span><br><span class="line">    <span class="keyword">if</span>((addr = ip-&gt;addrs[bn]) == <span class="number">0</span>)</span><br><span class="line">      ip-&gt;addrs[bn] = addr = balloc(ip-&gt;dev);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">  &#125;</span><br><span class="line">  bn -= NDIRECT;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(bn &lt; NINDIRECT)&#123;</span><br><span class="line">    <span class="keyword">if</span>((addr = ip-&gt;addrs[NDIRECT]) == <span class="number">0</span>)</span><br><span class="line">      ip-&gt;addrs[NDIRECT] = addr = balloc(ip-&gt;dev);</span><br><span class="line">	</span><br><span class="line">    bp = bread(ip-&gt;dev, addr);</span><br><span class="line">    a = (uint*)bp-&gt;data;</span><br><span class="line">    <span class="keyword">if</span>((addr = a[bn]) == <span class="number">0</span>)&#123;</span><br><span class="line">      a[bn] = addr = balloc(ip-&gt;dev);</span><br><span class="line">      log_write(bp);</span><br><span class="line">    &#125;</span><br><span class="line">    brelse(bp);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  bn -= NINDIRECT;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (bn &lt; NINDIRECT * NINDIRECT) &#123;</span><br><span class="line">    <span class="keyword">if</span>((addr = ip-&gt;addrs[NDIRECT+<span class="number">1</span>]) == <span class="number">0</span>)</span><br><span class="line">		ip-&gt;addrs[NDIRECT+<span class="number">1</span>] = addr = balloc(ip-&gt;dev);</span><br><span class="line"></span><br><span class="line">	bp = bread(ip-&gt;dev, addr);</span><br><span class="line"></span><br><span class="line">    a = (uint *)bp-&gt;data;</span><br><span class="line">    <span class="keyword">if</span> ((addr = a[bn/NINDIRECT]) == <span class="number">0</span>) &#123;</span><br><span class="line">       a[bn/NINDIRECT] = addr = balloc(ip-&gt;dev);</span><br><span class="line">	   log_write(bp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	bp2 = bread(ip-&gt;dev, addr);</span><br><span class="line"></span><br><span class="line">	a = (uint *)bp2-&gt;data;</span><br><span class="line">	<span class="keyword">if</span> ((addr = a[bn%NINDIRECT]) == <span class="number">0</span>) &#123;</span><br><span class="line">	  a[bn%NINDIRECT] = addr = balloc(ip-&gt;dev);</span><br><span class="line">      log_write(bp2);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	brelse(bp2);</span><br><span class="line">	brelse(bp);</span><br><span class="line">	<span class="keyword">return</span> addr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  panic(<span class="string">&quot;bmap: out of range&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据提示，修改<code>fs.h</code>：</p>
<ul>
<li>修改<code>#define NDIRECT 12</code>为<code>#define NDIRECT 11</code></li>
<li>修改<code>#define MAXFILE (NDIRECT + NINDIRECT)</code>为<code>#define MAXFILE (NDIRECT + NINDIRECT + NINDIRECT * NINDIRECT)</code></li>
<li>修改<code>uint addrs[NDIRECT+1]</code>为<code>uint addrs[NDIRECT+2]</code></li>
</ul>
<p>根据提示，修改<code>file.h</code>：</p>
<ul>
<li>修改<code>uint addrs[NDIRECT+1]</code>为<code>uint addrs[NDIRECT+2]</code></li>
</ul>
<p>最终重新运行<code>make qemu</code>并键入<code>big</code>，显示<code>wrote 16523 sectors</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> big</span></span><br><span class="line">.....................................................................................................................................................................</span><br><span class="line">wrote 16523 sectors</span><br><span class="line">done; ok</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.superpung.xyz/Xv6-homeworks/" data-id="ckkyvzn69002phejb9sxg7oop" data-title="Xv6 homeworks" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Experiments/" rel="tag">Experiments</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Operating-Systems/" rel="tag">Operating Systems</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/Win-VM-Ubuntu-20-04/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Windows&amp;VMware&amp;Ubuntu_20.04 Installation_Notes
        
      </div>
    </a>
  
  
    <a href="/Theory-Study-3/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">理论学习（三）</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computer-Systems/" rel="tag">Computer Systems</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Data-Structures/" rel="tag">Data Structures</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiments/" rel="tag">Experiments</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lab-Assignments/" rel="tag">Lab Assignments</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notes/" rel="tag">Notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Operating-Systems/" rel="tag">Operating Systems</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Others/" rel="tag">Others</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/Computer-Systems/" style="font-size: 16.67px;">Computer Systems</a> <a href="/tags/Data-Structures/" style="font-size: 18.33px;">Data Structures</a> <a href="/tags/Experiments/" style="font-size: 20px;">Experiments</a> <a href="/tags/Lab-Assignments/" style="font-size: 13.33px;">Lab Assignments</a> <a href="/tags/Notes/" style="font-size: 15px;">Notes</a> <a href="/tags/Operating-Systems/" style="font-size: 10px;">Operating Systems</a> <a href="/tags/Others/" style="font-size: 11.67px;">Others</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/VS-Code-Config/">VS Code on Windows Configuration_Notes</a>
          </li>
        
          <li>
            <a href="/macOS-PD-Ubuntu-20-04/">macOS&amp;Parallels_Desktop&amp;Ubuntu_20.04 Installation_Notes</a>
          </li>
        
          <li>
            <a href="/Win-VM-Ubuntu-20-04/">Windows&amp;VMware&amp;Ubuntu_20.04 Installation_Notes</a>
          </li>
        
          <li>
            <a href="/Xv6-homeworks/">Xv6 homeworks</a>
          </li>
        
          <li>
            <a href="/Theory-Study-3/">理论学习（三）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 SUPER<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>